name: Build and publish the master docker-ckan image
on:
  schedule:
    - cron: '15 5 * * *'

env:
  GAR_ZONE: europe-southwest1
  GAR_REPO_NAME: docker-ckan-images
  G_PROJECT_ID: oki-cloud
  G_SERVICE_ACCOUT: sa-gh-action-registry

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v0
        with:
          token_format: access_token
          workload_identity_provider: projects/3555635429/locations/global/workloadIdentityPools/gh-action-registry-pool/providers/gh-provider
          service_account: ${{ env.G_SERVICE_ACCOUT }}@${{ env.G_PROJECT_ID }}.iam.gserviceaccount.com
          access_token_lifetime: 600s

      - name: Login to Artifact Registry
        uses: docker/login-action@v1
        with:
          registry: ${{ env.GAR_ZONE }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - name: Build ckan-base master
        uses: docker/build-push-action@v4
        with:
          context: ckan-base
          file: ckan-base/master/Dockerfile
          push: true
          tags: |
            ${{ env.GAR_ZONE }}-docker.pkg.dev/${{ env.G_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/openknowledge/ckan-base:master

      - name: Build ckan-dev master
        uses: docker/build-push-action@v4
        with:
          context: ckan-dev
          file: ckan-dev/master/Dockerfile
          push: true
          tags: |
            ${{ env.GAR_ZONE }}-docker.pkg.dev/${{ env.G_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/openknowledge/ckan-dev:master
